<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Plant√µes UBS</title>

<style>
body{
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  background:#f2f2f7;
  margin:0;
  padding:12px;
  display:flex;
  justify-content:center;
}
.app{width:100%;max-width:420px}
h2,h3{text-align:center}

input,select,textarea,button{
  width:100%;
  padding:12px;
  margin:6px 0;
  font-size:16px;
  border-radius:12px;
  box-sizing:border-box;
}

button{background:#007aff;color:#fff;border:none}
.delete{background:#ff3b30}
.cancel{background:#8e8e93}

.card{
  background:#fff;
  padding:14px;
  border-radius:16px;
  margin-top:12px;
}

.check{
  display:flex;
  align-items:center;
  gap:8px;
  margin:4px 0;
}
.check input{width:auto}

.obs{font-size:13px;color:#666;margin-top:4px}

/* MODAIS */
.modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.4);
  justify-content:center;
  align-items:center;
}
.box{
  background:#fff;
  width:90%;
  max-width:380px;
  max-height:80vh;
  overflow:auto;
  border-radius:16px;
  padding:14px;
}

.check-ok{
  color:#34c759;
  font-weight:bold;
  margin-left:6px;
}


.item{border-bottom:1px solid #eee;padding:8px 0}

/* PLANT√ÉO CUMPRIDO */
.feito{
  background:#e9f9ee;
  border-left:6px solid #34c759;
  padding-left:8px;
}

/* TOAST */
#toast{
  position:fixed;
  bottom:30px;
  left:50%;
  transform:translateX(-50%);
  background:#2ecc71;
  color:#fff;
  padding:12px 18px;
  border-radius:14px;
  font-size:15px;
  display:none;
  z-index:999;
}
</style>
</head>

<body>
<div class="app">

<h2>üìÜ Plant√µes UBS</h2>

<!-- CADASTRO -->
<div class="card">
  <input type="date" id="data">

  <select id="local">
    <option>S√£o Bento</option>
    <option>Laranjeiras</option>
    <option>Julio de Mesquita</option>
  </select>

  <!-- HOR√ÅRIOS PADR√ÉO -->
  <div class="check">
    <input type="radio" name="horarioPadrao" onclick="setHorario('13-19')">
    <span>13:00 ‚Äì 19:00</span>
  </div>
  <div class="check">
    <input type="radio" name="horarioPadrao" onclick="setHorario('19-00')">
    <span>19:00 ‚Äì 00:00</span>
  </div>
  <div class="check">
    <input type="radio" name="horarioPadrao" checked onclick="setHorario('livre')">
    <span>Hor√°rio livre</span>
  </div>

  <input type="time" id="inicio">
  <input type="time" id="fim">

  <textarea id="obs" placeholder="Observa√ß√£o"></textarea>

  <button onclick="salvar()">Salvar</button>
  <button id="btnCancelar" class="cancel" style="display:none" onclick="cancelarEdicao()">Cancelar edi√ß√£o</button>
</div>

<!-- BOT√ïES -->
<div class="card">
  <button onclick="abrirVisual()">üëÅ Visualizar plant√µes</button>
  <button onclick="abrirGerenciar()">‚öôÔ∏è Gerenciar plant√µes</button>
</div>

<!-- RELAT√ìRIO -->
<h3>üìä Relat√≥rio</h3>
<div class="card">
  <input type="month" id="mesRel" onchange="atualizarRelatorio()">
  <div id="relatorio"></div>
</div>

<!-- MODAL VISUALIZAR -->
<div class="modal" id="modalVisual">
  <div class="box">
    <h3>Visualiza√ß√£o r√°pida</h3>
    <input type="month" id="filtroVisual" onchange="renderVisual()">
    <div id="listaVisual"></div>
    <button class="cancel" onclick="fecharVisual()">Fechar</button>
  </div>
</div>

<!-- MODAL GERENCIAR -->
<div class="modal" id="modalGerenciar">
  <div class="box">
    <h3>Gerenciar</h3>
    <input type="month" id="filtroGerMes" onchange="renderGerenciar()">
    <input type="text" id="pesquisaGer" placeholder="Pesquisar data, local, observa√ß√£o" oninput="renderGerenciar()">
    <div id="listaGerenciar"></div>
    <button class="cancel" onclick="fecharGerenciar()">Fechar</button>
  </div>
</div>

</div>

<!-- TOAST -->
<div id="toast">‚úÖ Plant√£o salvo</div>

<script>
let plantoes = JSON.parse(localStorage.getItem("plantoes")||"[]");
let editandoId=null;

function salvarLS(){
  localStorage.setItem("plantoes",JSON.stringify(plantoes));
}

function mostrarToast(){
  toast.style.display="block";
  setTimeout(()=>toast.style.display="none",1800);
}

function diaSemana(data){
  const dias=["Domingo","Segunda","Ter√ßa","Quarta","Quinta","Sexta","S√°bado"];
  return dias[new Date(data+"T00:00").getDay()];
}

function horas(inicio,fim){
  let [h1,m1]=inicio.split(":").map(Number);
  let [h2,m2]=fim.split(":").map(Number);
  let a=h1*60+m1, b=h2*60+m2;
  if(b<=a) b+=1440;
  return ((b-a)/60).toFixed(1);
}

function adicionalNoturno(inicio,fim){
  let ini=inicio.split(":").map(Number);
  let f=fim.split(":").map(Number);
  let inicioMin=ini[0]*60+ini[1];
  let fimMin=f[0]*60+f[1];
  if(fimMin<=inicioMin) fimMin+=1440;
  let iniCalc=Math.max(inicioMin,22*60);
  let fimCalc=Math.min(fimMin,24*60);
  return Math.max(0,(fimCalc-iniCalc)/60);
}

function setHorario(tipo){
  if(tipo==="13-19"){inicio.value="13:00";fim.value="19:00";inicio.disabled=fim.disabled=true}
  else if(tipo==="19-00"){inicio.value="19:00";fim.value="00:00";inicio.disabled=fim.disabled=true}
  else{inicio.disabled=fim.disabled=false;inicio.value="";fim.value=""}
}

function salvar(){
  if(!data.value||!inicio.value||!fim.value) return alert("Preencha tudo");

  if(editandoId){
    Object.assign(plantoes.find(x=>x.id===editandoId),{
      data:data.value,local:local.value,inicio:inicio.value,fim:fim.value,obs:obs.value
    });
  } else {
    plantoes.push({
      id:Date.now(),data:data.value,local:local.value,
      inicio:inicio.value,fim:fim.value,obs:obs.value,
      cumprido:false,cem:false
    });
  }

  salvarLS();
  mostrarToast();
  cancelarEdicao();
  atualizarRelatorio();
  renderTudo();
}

function editar(id){
  let p=plantoes.find(x=>x.id===id);
  data.value=p.data;local.value=p.local;
  inicio.value=p.inicio;fim.value=p.fim;obs.value=p.obs||"";
  inicio.disabled=fim.disabled=false;
  editandoId=id;btnCancelar.style.display="block";
  fecharGerenciar();
}

function apagar(id){
  if(!confirm("Apagar plant√£o?")) return;
  plantoes=plantoes.filter(p=>p.id!==id);
  salvarLS();atualizarRelatorio();renderTudo();
}

function toggleCampo(id,campo,valor){
  plantoes.find(x=>x.id===id)[campo]=valor;
  salvarLS();atualizarRelatorio();
}

function cancelarEdicao(){
  editandoId=null;
  btnCancelar.style.display="none";
  data.value=inicio.value=fim.value=obs.value="";
  inicio.disabled=fim.disabled=false;
}

function abrirVisual(){modalVisual.style.display="flex";renderVisual()}
function fecharVisual(){modalVisual.style.display="none"}

function renderVisual(){
  listaVisual.innerHTML="";
  [...plantoes]
    .filter(p=>!filtroVisual.value||p.data.startsWith(filtroVisual.value))
    .sort((a,b)=>a.data.localeCompare(b.data))
    .forEach(p=>{
      listaVisual.innerHTML+=`
      <div class="item ${p.cumprido?'feito':''}">
        <b>
  ${p.data.split("-").reverse().join("/")} (${diaSemana(p.data)})
  ${p.cumprido ? '<span class="check-ok">‚úîÔ∏è</span>' : ''}
</b><br>

        ${p.local}<br>
        ${p.inicio} √†s ${p.fim}
        ${p.obs?`<div class="obs">üìù ${p.obs}</div>`:""}
      </div>`;
    });
}

function abrirGerenciar(){modalGerenciar.style.display="flex";renderGerenciar()}
function fecharGerenciar(){modalGerenciar.style.display="none"}

function renderGerenciar(){
  listaGerenciar.innerHTML="";
  let q=pesquisaGer.value.toLowerCase(),mes=filtroGerMes.value;
  plantoes.filter(p=>(!mes||p.data.startsWith(mes))&&
    (p.data.includes(q)||p.local.toLowerCase().includes(q)||(p.obs||"").toLowerCase().includes(q))
  ).forEach(p=>{
    listaGerenciar.innerHTML+=`
    <div class="item">
      <b>${p.data.split("-").reverse().join("/")} (${diaSemana(p.data)})</b> ‚Äì ${p.local}<br>
      ${p.inicio} √†s ${p.fim} (${horas(p.inicio,p.fim)}h)
      ${p.obs?`<div class="obs">üìù ${p.obs}</div>`:""}
      <div class="check">
        <input type="checkbox" ${p.cumprido?"checked":""}
        onchange="toggleCampo(${p.id},'cumprido',this.checked)">
        <span>Cumprido</span>
      </div>
      <div class="check">
        <input type="checkbox" ${p.cem?"checked":""}
        onchange="toggleCampo(${p.id},'cem',this.checked)">
        <span>Dom/Feriado (100%)</span>
      </div>
      <button onclick="editar(${p.id})">Editar</button>
      <button class="delete" onclick="apagar(${p.id})">Apagar</button>
    </div>`;
  });
}

function atualizarRelatorio(){
  let mes=mesRel.value,h50=0,h100=0,a50=0,a100=0;
  plantoes.forEach(p=>{
    if(!p.cumprido||mes&&!p.data.startsWith(mes))return;
    let h=parseFloat(horas(p.inicio,p.fim)),a=adicionalNoturno(p.inicio,p.fim);
    p.cem?(h100+=h,a100+=a):(h50+=h,a50+=a);
  });
  relatorio.innerHTML=
    `50%: ${h50.toFixed(1)}h <span class="obs">(Adic: ${a50.toFixed(1)}h)</span><br>
     100%: ${h100.toFixed(1)}h <span class="obs">(Adic: ${a100.toFixed(1)}h)</span>`;
}

function renderTudo(){renderVisual();renderGerenciar()}
atualizarRelatorio();
</script>
</body>
</html>
